<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />

    

    

    <title>Lien Li&#39;s Blog</title>
    <meta name="author" content="Lien Li" />
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />

    
    <link rel="alternate" href="/atom.xml" title="Lien Li&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/images/apple-icon-72x72.png">
    

    <style type="text/css">
    @font-face {
        font-family: 'icomoon';
        src: url("/fonts/icomoon.eot?q628ml");
        src: url("/fonts/icomoon.eot?q628ml#iefix") format('embedded-opentype'),
             url("/fonts/icomoon.ttf?q628ml") format('truetype'),
             url("/fonts/icomoon.woff?q628ml") format('woff'),
             url("/fonts/icomoon.svg?q628ml#icomoon") format('svg');
        font-weight: normal;
        font-style: normal;
    }
    </style>
    
<link rel="stylesheet" href="/css/style.css">


    <!--[if lt IE 9]><style type="text/css">.nav-inner {top:0;}.author-meta {position:static;top:0;}.search-form {height:36px;}</style><script type="text/javascript" src="https://unpkg.com/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
<meta name="generator" content="Hexo 5.4.2"></head>
<body>

    <main class="app">
        <header id="header" class="header clearfix">
    <div id="nav" class="nav">
    <div class="nav-mobile">
        <button id="open-panel" class="open-panel nav-mobile-item"><i class="icon-documents"></i></button>
        <h1 class="nav-mobile-title nav-mobile-item">Lien Li&#39;s Blog</h1>
        <button id="open-menus" class="open-panel nav-mobile-item"><i class="icon-library"></i></button>
    </div>

    <nav id="nav-inner" class="nav-inner">
        
            <a class="nav-item active" href="/">
                <span class="nav-text">Home</span>
            </a>
        
            <a class="nav-item" href="/tags/frontend">
                <span class="nav-text">Frontend</span>
            </a>
        
            <a class="nav-item" href="/tags/backend">
                <span class="nav-text">Backend</span>
            </a>
        
            <a class="nav-item" href="/tags">
                <span class="nav-text">Tags</span>
            </a>
        
            <a class="nav-item" href="/archives">
                <span class="nav-text">Archives</span>
            </a>
        
            <a class="nav-item" href="/atom.xml">
                <span class="nav-text">RSS</span>
            </a>
        
            <a class="nav-item" href="/about">
                <span class="nav-text">About</span>
            </a>
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit"><i class="icon-search-stroke"></i></button><input type="hidden" name="sitesearch" value="http://blog.hellotalk.org"></form>

        
        

        
        <div class="author-meta">
            
            <div class="author-avatar">
                <a href="/">
                    <img src="https://avatars.githubusercontent.com/u/3814966?v=4" title="Lien Li">
                </a>
            </div>
            
            <div class="author-name">Lien Li</div>
            <div class="author-work">Open Source Developer &amp; Debugger</div>
            <div class="author-location">
                <i class="icon-location vm"></i>
                <span class="vm">Shenzhen, China</span>
            </div>
            
            <div class="author-thread-wrap">
                <div class="author-threads clearfix">
                    
                        <a class="thread-item" href="https://github.com/lilien1010" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewBox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512 32.12c-265.004 0-479.88 220.23-479.88 492.090 0 217.446 137.536 401.684 328.202 466.81 23.994 4.498 32.778-10.712 32.778-23.78 0-11.782-0.428-42.632-0.642-83.764-133.466 29.778-161.744-65.984-161.744-65.984-21.852-56.772-53.344-71.982-53.344-71.982-43.49-30.636 3.214-29.992 3.214-29.992 48.202 3.428 73.482 50.772 73.482 50.772 42.846 75.196 112.258 53.558 139.68 40.918 4.284-31.706 16.71-53.558 30.42-65.77-106.474-12.426-218.516-54.63-218.516-243.152 0-53.772 18.638-97.69 49.274-131.966-4.928-12.426-21.424-62.556 4.714-130.252 0 0 40.276-13.282 131.966 50.344 38.348-10.926 79.266-16.282 120.184-16.496 40.704 0.214 81.836 5.57 120.184 16.496 91.692-63.626 131.752-50.344 131.752-50.344 26.136 67.698 9.64 117.828 4.714 130.252 30.636 34.492 49.274 78.408 49.274 131.966 0 188.952-112.258 230.514-219.16 242.724 17.138 15.21 32.564 45.202 32.564 91.048 0 65.77-0.642 118.898-0.642 134.966 0 13.068 8.57 28.492 32.992 23.566 191.094-64.912 328.418-249.152 328.418-466.382 0-271.86-214.874-492.090-479.88-492.090z"></path>
</svg>

                        </a>
                    
                        <a class="thread-item" href="https://twitter.com/LeenuxLee" target="_blank" rel="noopener">
                            <!-- Generated by IcoMoon.io -->
<svg viewBox="0 0 1024 1024" width="38" height="38" fill="currentColor">
<path d="M512.029 31.011c-263.32 0-476.784 213.502-476.784 476.784 0 263.32 213.464 476.743 476.784 476.743s476.743-213.424 476.743-476.743c0-263.282-213.444-476.784-476.743-476.784zM752.193 411.663c0.251 5.151 0.349 10.319 0.349 15.548 0 158.786-120.856 341.85-341.85 341.85-67.844 0-131.021-19.884-184.188-53.961 9.41 1.104 18.955 1.665 28.656 1.665 56.305 0 108.115-19.208 149.221-51.425-52.567-0.987-96.925-35.741-112.22-83.468 7.32 1.433 14.85 2.149 22.595 2.149 10.959 0 21.569-1.433 31.656-4.201-54.987-11.035-96.402-59.634-96.402-117.796 0-0.524 0-1.025 0.020-1.549 16.186 9.003 34.716 14.404 54.427 15.044-32.258-21.587-53.458-58.317-53.458-100.023 0-22.015 5.925-42.673 16.264-60.408 59.266 72.683 147.807 120.527 247.676 125.521-2.053-8.77-3.118-17.968-3.118-27.378 0-66.333 53.787-120.14 120.158-120.14 34.561 0 65.771 14.599 87.69 37.93 27.378-5.363 53.091-15.393 76.305-29.16-9.003 28.074-28.036 51.618-52.858 66.47 24.338-2.903 47.495-9.37 69.024-18.917-16.070 24.144-36.459 45.306-59.945 62.248z"></path>
</svg>

                        </a>
                    
                </div>
            </div>
            
        </div>
        
    </div>
</aside>

</header>

        <div id="content" class="content">
            <div id="wrapper" class="wrapper" style="max-width: 800px">
                
    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2022/09/29/2022%E6%9C%80%E6%96%B0%E4%BF%9D%E5%A7%86%E7%BA%A7%E6%95%99%E7%A8%8B-%E5%B8%A6%E5%A8%83%E5%8E%BB%E6%96%B0%E5%8A%A0%E5%9D%A1%E8%A6%81%E6%80%8E%E4%B9%88%E7%BB%99%E5%AD%A9%E5%AD%90%E5%8A%9E%E7%90%86%E7%96%AB%E8%8B%97%E5%85%AC%E8%AF%81-VERIFICATION-OF-VACCINATION%EF%BC%9F%EF%BC%81/">2022最新保姆级教程-带娃去新加坡要怎么给孩子办理疫苗公证-VERIFICATION OF VACCINATION？！</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2022-09-29T01:52:34.000Z" itemprop="datePublished">2022-09-29</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h1 id="保姆级教程-带娃去新加坡要怎么给孩子办理疫苗公证？！"><a href="#保姆级教程-带娃去新加坡要怎么给孩子办理疫苗公证？！" class="headerlink" title="保姆级教程-带娃去新加坡要怎么给孩子办理疫苗公证？！"></a>保姆级教程-带娃去新加坡要怎么给孩子办理疫苗公证？！</h1><p>带孩子去新加坡的话，一般都是DP家属签证或者学生签证，无论那种都是需要在新加坡的HPB网站办理一个疫苗公证（又叫 VERIFICATION OF VACCINATION），然后才能申请签证，简单来说就是上传一系列的PDF，再缴30新币，得到下图PDF文件，这个PDF是申请家属签证必须提供的材料，而且一般代理办EP的也不会帮你申请，需要自己申请。</p>
<p><img src="/images/VERIFICATION-VACCINATION/Untitled.png" alt="Untitled"></p>
<p>申请网站：<a target="_blank" rel="noopener" href="https://www.nir.hpb.gov.sg/fcine/">https://www.nir.hpb.gov.sg/fcine/</a></p>
<h2 id="要准备的草料（带去”国际旅行卫生保健中心“）："><a href="#要准备的草料（带去”国际旅行卫生保健中心“）：" class="headerlink" title="要准备的草料（带去”国际旅行卫生保健中心“）："></a>要准备的草料（带去”国际旅行卫生保健中心“）：</h2><ul>
<li><input disabled="" type="checkbox"> 儿童2寸彩色照片</li>
<li><input disabled="" type="checkbox"> 儿童+父母的护照</li>
<li><input disabled="" type="checkbox"> 原国内的绿色疫苗本</li>
<li><input disabled="" type="checkbox"> 儿童身份证</li>
<li><input disabled="" type="checkbox"> 从新加坡HPB网上下载的 ImmunisationFormsForForeignChild.pdf 并打印出来。</li>
</ul>
<h2 id="操作说明："><a href="#操作说明：" class="headerlink" title="操作说明："></a>操作说明：</h2><p>因为向HPB申请疫苗公证的时候需要提交曾经接种白喉（diphtheria）及麻疹（measles）的记录。</p>
<p><strong>白喉（Diphtheria）</strong>：注射的第一针必须至少在六周以上，否则视为无效，需要重新注射，达到最低两针的要求。<strong>一般来说，中国孩子基本不需要补打白喉疫苗。</strong></p>
<p><strong>麻疹（Measles）</strong>：注射的第一针必须至少在<strong>一周岁以后</strong>（含一周岁），否则视为无效，需要重新注射，达到最低两针的要求。</p>
<p>在中国，<strong>麻疹疫苗是在8月龄接种的，所以中国的孩子到新加坡基本上都要去”国际旅行卫生保健中心“补打MMR。</strong></p>
<p>同时需要在”国际旅行卫生保健中心“拿到翻译过的疫苗原始记录（IMMUNIZATION RECORD），一般夹在小黄本里面。</p>
<h2 id="操作步骤："><a href="#操作步骤：" class="headerlink" title="操作步骤："></a>操作步骤<strong>：</strong></h2><ol>
<li><p>先电话咨询去当地的”国际旅行卫生保健中心“，询问有没有苗，说补打麻腮风疫苗（通常现在打的是三联疫苗MMR）</p>
</li>
<li><p>然后在”国际旅行卫生保健中心“ 得到一本黄色的”疫苗接种或预防措施国际证书“，内附了翻译过的小孩曾经打过的疫苗说明（IMMUNIZATION RECORD）以及公章记录，如下图（把所有页面都拍照做成一个 PDF-1）。</p>
<p> <img src="/images/VERIFICATION-VACCINATION/Untitled.jpeg" alt="Untitled"></p>
<p> <img src="/images/VERIFICATION-VACCINATION/WeChatWorkScreenshot_4d222190-5c12-43fb-9fe7-253ccfd956ff.jpg" alt="WeChatWorkScreenshot_4d222190-5c12-43fb-9fe7-253ccfd956ff.jpg"></p>
</li>
<li><p>在打完疫苗之后，把打印的 ”Immunisation Registration Form“，交给那边的办事人员填写一个完整的疫苗记录，同时家长记得在 SECTION 3 签名。（把第一页和第二页拍照做一个PDF-2）</p>
<p> <img src="/images/VERIFICATION-VACCINATION/Untitled%201.png" alt="Untitled"></p>
</li>
<li><p>去当地“公证处”给小孩的<strong>出生证</strong>做公证和翻译，大概需要1周的时间，所以可以提前做（把出生证原件和翻译件拍照做到一个PDF里面，PDF-3）</p>
</li>
<li><p>把父母的护照详情页拍照 放到一个 PDF 里面，PDF-4。</p>
</li>
<li><p>准备上述4个PDF文件</p>
</li>
<li><p>去HPB网站提交疫苗和身份信息。</p>
</li>
</ol>
<p>其中要注意的是，在HPB的网站里面 有些 Vaccine Name 可能和 ImmunisationFormsForForeignChild.pdf 最后一页的名字对不上，但是其实我操作下来只要名字大概对得上就可以了，如下图。</p>
<p><img src="/images/VERIFICATION-VACCINATION/Untitled%202.png" alt="Untitled"></p>
<p>最后上面的4个PDF（控制2MB以内）都准备好了可以去HPB的网站去申请了。缴完30新币的注册费 就等HPB的email就可以了。 </p>
<p><strong>推荐几个我常用的照片转PDF工具</strong></p>
<p>iPhone导出图片太大需要把 heic 批量转为jpg：  h<a target="_blank" rel="noopener" href="https://heictojpg.com/">ttps://heictojpg.com/</a></p>
<p>把多个jpg做成 PDF ： h<a target="_blank" rel="noopener" href="https://www.ilovepdf.com/zh-cn/jpg_to_pdf">ttps://www.ilovepdf.com/zh-cn/jpg_to_pdf</a></p>
<h2 id="等待结果："><a href="#等待结果：" class="headerlink" title="等待结果："></a>等待结果：</h2><p>目前大概需要20个工作日，如果有问题 HPB的 email （下图1） 会告诉你需要补充什么资料的。</p>
<p>才能拿到最后的疫苗公证，如下图2的PDF，然后再去申请DP了。</p>
<p><img src="/images/VERIFICATION-VACCINATION/Untitled%203.png" alt="Untitled"></p>
<p><img src="/images/VERIFICATION-VACCINATION/Untitled.png" alt="Untitled"></p>
<h3 id="关于新冠疫苗"><a href="#关于新冠疫苗" class="headerlink" title="关于新冠疫苗"></a>关于新冠疫苗</h3><p>12岁及以下未完全接种疫苗可赦免，13岁以上需要。</p>
<p>进入“防疫健康码国际版”微信小程序，点击“出国人员入口”下的“查看及出示国际旅行健康证明”。</p>
<p>根据小程序提示填写个人信息后，就可以得到一份pdf版本的国际旅行健康证明了。</p>
<p>拿到国际旅行健康证明之后，我们需要登录新加坡SafeTravel官网，填写个人信息并上传证明之后，就可以拿到一封疫苗接受信（vaccination acceptance letter），它可以帮我们更加顺利地入境。</p>
<p>疫苗认证链接：</p>
<p><a target="_blank" rel="noopener" href="https://eservices.ica.gov.sg/STO1/VCP">https://eservices.ica.gov.sg/STO1/VCP</a></p>
<p><img src="/images/VERIFICATION-VACCINATION/Untitled%204.png" alt="Untitled"></p>
<p>来源：</p>
<p><a target="_blank" rel="noopener" href="https://www.shicheng.news/v/nzvx8">https://www.shicheng.news/v/nzvx8</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/IRBsuMELYLYRTCsOH6r37A">https://mp.weixin.qq.com/s/IRBsuMELYLYRTCsOH6r37A</a></p>
<p><a target="_blank" rel="noopener" href="https://vasteredu.com/news/18.html">https://vasteredu.com/news/18.html</a></p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/04/14/Build-a-specialized-fields-Chinese-full-text-search-engine-with-Elasticsearch-IKAnalysis-jieba/">Build a specialized fields Chinese full-text search engine with Elasticsearch/IKAnalysis/jieba</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-04-14T11:26:13.000Z" itemprop="datePublished">2021-04-14</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/Elasticsearch/" rel="tag">Elasticsearch</a>, <a class="article-tag-link" href="/tags/backend/" rel="tag">backend</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a>Background</h2><p>  Many projects often need a search engine, but for Chinese content, we can not simply use <code>MySQL like</code> to search, especially for the professional field Chinese sentence search, we need specialized words from corpus to bring better search result, because the Chinese words are not split with spaces, which requires us to do two things.</p>
<ul>
<li>1 Extract specialized words/vocabulary from corpus existed, such as brand, character names, you can also polish your dict manually.</li>
<li>2 Import that specialized vocabulary into the search engine and the search engine(Elasticsearch) can index those keywords split by IK analyzer.</li>
</ul>
<h2 id="Prerequisite"><a href="#Prerequisite" class="headerlink" title="Prerequisite"></a>Prerequisite</h2><p><a target="_blank" rel="noopener" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/docs.html">Elasticsearch</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/medcl/elasticsearch-analysis-ik">Elasticsearch Analysis Plugin: IK</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/fxsjy/jieba">Jieba stutter, Chinese text segmentation tool</a></p>
<p>Other Option: <a target="_blank" rel="noopener" href="https://github.com/NLPchina/ansj_seg">https://github.com/NLPchina/ansj_seg</a></p>
<h2 id="How-to-do-it"><a href="#How-to-do-it" class="headerlink" title="How to do it"></a>How to do it</h2><h3 id="Install-Elasticsearch-Kibana-IKAnalysis-with-Docker"><a href="#Install-Elasticsearch-Kibana-IKAnalysis-with-Docker" class="headerlink" title="Install Elasticsearch/Kibana/IKAnalysis with Docker"></a>Install Elasticsearch/Kibana/IKAnalysis with Docker</h3><p>docker-compose.yml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">version: &#x27;2.2&#x27;</span><br><span class="line">services:</span><br><span class="line">  kibana:</span><br><span class="line">    image: docker.elastic.co/kibana/kibana:7.11.2</span><br><span class="line">    volumes:</span><br><span class="line">      - ./kibana.yml:/usr/share/kibana/config/kibana.yml</span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line">    ports:</span><br><span class="line">      - 9601:9601</span><br><span class="line">      - 8893:8893</span><br><span class="line">    environment:</span><br><span class="line">      SERVER_NAME: kibana.example.org</span><br><span class="line">      ELASTICSEARCH_HOSTS: http://172.17.0.3:9200</span><br><span class="line">  es01:</span><br><span class="line">    image: docker.elastic.co/elasticsearch/elasticsearch:7.11.2</span><br><span class="line">    container_name: es01</span><br><span class="line">    environment:</span><br><span class="line">      - node.name=es01</span><br><span class="line">      - cluster.name=es-docker-cluster</span><br><span class="line">      - cluster.initial_master_nodes=es01</span><br><span class="line">      - bootstrap.memory_lock=true</span><br><span class="line">      - &quot;ES_JAVA_OPTS=-Xms4g -Xmx4g&quot;</span><br><span class="line">    ulimits:</span><br><span class="line">      memlock:</span><br><span class="line">        soft: -1</span><br><span class="line">        hard: -1</span><br><span class="line">    volumes:</span><br><span class="line">      - data01:/usr/share/elasticsearch/data</span><br><span class="line">      - ./plugin/ik:/usr/share/elasticsearch/plugins/ik</span><br><span class="line">    ports:</span><br><span class="line">      - 0.0.0.0:9200:9200</span><br><span class="line">    networks:</span><br><span class="line">      - elastic</span><br><span class="line"></span><br><span class="line">volumes:</span><br><span class="line">  data01:</span><br><span class="line">    driver: local</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  elastic:</span><br><span class="line">    driver: bridge</span><br><span class="line">    ipam:</span><br><span class="line">      driver: default</span><br><span class="line">      config:</span><br><span class="line">        - subnet: 172.33.238.0/24</span><br></pre></td></tr></table></figure>

<p>kibana.yml </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server.port: 9601</span><br><span class="line">server.host: &quot;0.0.0.0&quot;</span><br><span class="line">enterpriseSearch.host: &quot;http://172.17.0.3:9200&quot;</span><br><span class="line">elasticsearch.hosts: &quot;http://172.17.0.3:9200&quot;</span><br></pre></td></tr></table></figure>

<p>How directory looks like is below<br>We need download <code>elasticsearch-analysis-ik-7.11.2.zip</code> and unzip it in directory <code>plugin</code> as we mapped it in <code>volumes</code> in file <code>docker-compose.yml</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">./</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">├── kibana.yml</span><br><span class="line">└── plugin</span><br><span class="line">    └── ik</span><br><span class="line">        ├── commons-codec-1.9.jar</span><br><span class="line">        ├── commons-logging-1.2.jar</span><br><span class="line">        ├── config</span><br><span class="line">        │   ├── extra_main.dic</span><br><span class="line">        │   ├── extra_single_word.dic</span><br><span class="line">        │   ├── extra_single_word_full.dic</span><br><span class="line">        │   ├── extra_single_word_low_freq.dic</span><br><span class="line">        │   ├── extra_stopword.dic</span><br><span class="line">        │   ├── Cosmetics.dic</span><br><span class="line">        │   ├── IKAnalyzer.cfg.xml</span><br><span class="line">        │   ├── main.dic</span><br><span class="line">        │   ├── preposition.dic</span><br><span class="line">        │   ├── quantifier.dic</span><br><span class="line">        │   ├── stopword.dic</span><br><span class="line">        │   ├── suffix.dic</span><br><span class="line">        │   └── surname.dic</span><br><span class="line">        ├── elasticsearch-analysis-ik-7.11.2.jar</span><br><span class="line">        ├── elasticsearch-analysis-ik-7.11.2.zip</span><br><span class="line">        ├── httpclient-4.5.2.jar</span><br><span class="line">        ├── httpcore-4.4.4.jar</span><br><span class="line">        ├── plugin-descriptor.properties</span><br><span class="line">        └── plugin-security.policy</span><br></pre></td></tr></table></figure>

<p><code>Cosmetics.dic</code> is the file that contains Chinese word that need to be tokenized.<br>here is the example of some cosmetics brands</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">烟酰胺</span><br><span class="line">抗蓝光</span><br><span class="line">康萃乐</span><br><span class="line">怡丽丝尔</span><br></pre></td></tr></table></figure>

<h2 id="Segmentation-get-Cosmetics-dic-from-corpus"><a href="#Segmentation-get-Cosmetics-dic-from-corpus" class="headerlink" title="Segmentation (get Cosmetics.dic from corpus)"></a>Segmentation (get Cosmetics.dic from corpus)</h2><p>Here we need <a target="_blank" rel="noopener" href="https://github.com/fxsjy/jieba">Jieba Segmentation Tool</a> which is intent to built the best Python Chinese word segmentation module.<br>corpus need to be ready in with txt format.<br>the corpus should contains specialized Chinese words</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone github.com/fxsjy/jieba</span><br><span class="line">cd jieba/test</span><br><span class="line">python extract_tags_with_weight.py chinese-specialized-corpus.txt -k 10000 -w 1</span><br></pre></td></tr></table></figure>

<p>take cosmetics corpus as an example, the result should like below, those result can import to <code>Cosmetics.dic</code>.</p>
<p>if possible, with manually edited and refined keyword brings better search experience</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">tag: 50ml		 weight: 0.213126</span><br><span class="line">tag: 雅诗兰黛		 weight: 0.155035</span><br><span class="line">tag: ysl		 weight: 0.144286</span><br><span class="line">tag: 新版		 weight: 0.143799</span><br><span class="line">tag: 面霜		 weight: 0.139773</span><br><span class="line">tag: 100ml		 weight: 0.132471</span><br><span class="line">tag: 阿玛尼		 weight: 0.116844</span><br><span class="line">tag: 兰蔻		 weight: 0.114584</span><br><span class="line">tag: 粉底液		 weight: 0.113962</span><br><span class="line">tag: 香奈儿		 weight: 0.108075</span><br><span class="line">tag: 精华		 weight: 0.104448</span><br><span class="line">tag: 30ml		 weight: 0.100020</span><br><span class="line">tag: sk2		 weight: 0.099609</span><br><span class="line">tag: 科颜氏		 weight: 0.091035</span><br><span class="line">tag: 面膜		 weight: 0.089536</span><br><span class="line">tag: 洁面		 weight: 0.086686</span><br></pre></td></tr></table></figure>


<h3 id="IK-Configration"><a href="#IK-Configration" class="headerlink" title="IK Configration"></a>IK Configration</h3><p>plugin/ik/config/IKAnalyzer.cfg.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">	&lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;</span><br><span class="line">	&lt;!--Users can configure their own extended dictionary here--&gt;</span><br><span class="line">	&lt;entry key=&quot;ext_dict&quot;&gt;/root/plugin/ik/config/huazhuangping.dic&lt;/entry&gt;</span><br><span class="line">	 &lt;!--Users can configure their own extended stop word dictionary here--&gt;</span><br><span class="line">	&lt;entry key=&quot;ext_stopwords&quot;&gt;&lt;/entry&gt;</span><br><span class="line">	&lt;!--Users can configure the remote extension link here --&gt;</span><br><span class="line">	&lt;entry key=&quot;remote_ext_dict&quot;&gt;https://xxxxxx/word_for_elasticsearch.txt&lt;/entry&gt;</span><br><span class="line">	&lt;!--The user can configure the remote extension stop word dictionary here--&gt;</span><br><span class="line">	&lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>

<h2 id="Test-IK-Tokenazier"><a href="#Test-IK-Tokenazier" class="headerlink" title="Test IK Tokenazier"></a>Test IK Tokenazier</h2><p>Open kibana dev <a target="_blank" rel="noopener" href="http://kibana.xxx.com/app/dev_tools#/console">http://kibana.xxx.com/app/dev_tools#/console</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">POST yunzhaohuo_index/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;ik_smart&quot;,</span><br><span class="line">    &quot;text&quot;: &quot;纪梵希润唇抗蓝光&quot;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Here, we can see the parser has take effective, and the text above has been split into three different Chinese words</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;tokens&quot; : [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;纪梵希&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 0,</span><br><span class="line">      &quot;end_offset&quot; : 3,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;润唇&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 3,</span><br><span class="line">      &quot;end_offset&quot; : 5,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 1</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;token&quot; : &quot;抗蓝光&quot;,</span><br><span class="line">      &quot;start_offset&quot; : 5,</span><br><span class="line">      &quot;end_offset&quot; : 8,</span><br><span class="line">      &quot;type&quot; : &quot;CN_WORD&quot;,</span><br><span class="line">      &quot;position&quot; : 2</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ES-Configrations"><a href="#ES-Configrations" class="headerlink" title="ES Configrations"></a>ES Configrations</h2><h3 id="1-Create-Index"><a href="#1-Create-Index" class="headerlink" title="1: Create Index"></a>1: Create Index</h3><p>run in Shell to create index</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -XPUT http://localhost:9200/product_inventory</span><br></pre></td></tr></table></figure>

<h3 id="2-Create-mapping-for-index-with-ik-smart"><a href="#2-Create-mapping-for-index-with-ik-smart" class="headerlink" title="2: Create mapping for index with ik_smart"></a>2: Create mapping for index with ik_smart</h3><p>Suppose we are creating a search engine for ecommercial with field <code>Id</code>,<code>product_desc</code><br>and <code>product_desc</code> is the field that we want to search with full-text.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST http://localhost:9200/product_inventory/_mapping -H &#x27;Content-Type:application/json&#x27; -d&#x27;&#123;</span><br><span class="line">      &quot;properties&quot; : &#123;</span><br><span class="line">        &quot;@timestamp&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;date&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Id&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;product_desc&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;text&quot;,</span><br><span class="line">          &quot;analyzer&quot;: &quot;ik_max_word&quot;,</span><br><span class="line">          &quot;search_analyzer&quot;: &quot;ik_max_word&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;price&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;long&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;updateTime&quot; : &#123;</span><br><span class="line">          &quot;type&quot; : &quot;date&quot;,</span><br><span class="line">          &quot;format&quot; : &quot;yyyy-MM-dd HH:mm:ss&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"> &#125;&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="3-Insert-Data-to-ES"><a href="#3-Insert-Data-to-ES" class="headerlink" title="3: Insert Data to ES"></a>3: Insert Data to ES</h3><p>Run in kiaban <a target="_blank" rel="noopener" href="http://kibana.xxx.com/app/dev_tools#/console">Dev Console</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /product_inventory/_create/1</span><br><span class="line">&#123;</span><br><span class="line">    &quot;product_desc&quot;:&quot;抗蓝光洗面奶&quot;,</span><br><span class="line">    &quot;price&quot;:&quot;3&quot;,</span><br><span class="line">    &quot;updateTime&quot;:&quot;2021-01-03 12:22:11&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="4-Search-Data-from-ES"><a href="#4-Search-Data-from-ES" class="headerlink" title="4: Search Data from ES"></a>4: Search Data from ES</h3><p>Search with _score sorted, you will see those result with _score.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /yunzhaohuo_index/_search?size=995&amp;from=0</span><br><span class="line">&#123;</span><br><span class="line">  </span><br><span class="line">    &quot;query&quot; : &#123;</span><br><span class="line">      &quot;match&quot;: &#123;</span><br><span class="line">         &quot;product_desc&quot;: &quot;抗蓝光&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;: &#123;</span><br><span class="line">      &quot;_score&quot; : &quot;desc&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/04/13/Fix-React-Native-Project-build-issues-ld-library-not-found-for-lCocoaAsyncSocket/">Fix React-Native Project build issues, ld: library not found for -lCocoaAsyncSocket</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-04-13T03:20:10.000Z" itemprop="datePublished">2021-04-13</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/ReactNative/" rel="tag">ReactNative</a>, <a class="article-tag-link" href="/tags/frontend/" rel="tag">frontend</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>During my work with xcode to build my RN app, I was having a linker issue this:<br><code>ld: library not found for -lCocoaAsyncSocket</code></p>
<p><img src="/images/2021-04-15-11-21-17.png"></p>
<p>Finnaly I was able to fix it with this comment<br><code>Switch the Legacy build system to New build system in Xcode.</code> in </p>
<p>Xcode:  File -&gt; File -&gt; Project Settings</p>
<p><a target="_blank" rel="noopener" href="https://github.com/react-native-community/upgrade-support/issues/36#issuecomment-663089338">Github Comments</a></p>
<p><img src="/images/2021-04-15-11-24-35.png"></p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/04/11/Deploy-Apache-APISIX-on-Kubesphere-3-0/">Deploy Apache APISIX on Kubesphere 3.0</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-04-11T14:24:19.000Z" itemprop="datePublished">2021-04-11</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        
        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/04/11/Golang-%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD-protobuffer-%E6%96%87%E4%BB%B6%E4%B9%8B%E5%8A%A8%E6%80%81%E8%A7%A3%E6%9E%90pb%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%95%B0%E6%8D%AE-%E8%BE%93%E5%87%BAJSON/">Golang 动态加载 protobuffer 文件之动态解析pb二进制数据,输出JSON</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-04-11T14:13:22.000Z" itemprop="datePublished">2021-04-11</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/Golang/" rel="tag">Golang</a>, <a class="article-tag-link" href="/tags/Protobuffer/" rel="tag">Protobuffer</a>, <a class="article-tag-link" href="/tags/backend/" rel="tag">backend</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>在业务中经常有这种需求，给某某服务加一个命令字，用来接收的RPC 请求来的protobuffer数据，按照某个pb数据定义反序列化之后，转成JSON 再传输到下游服务。</p>
<p>如果安装我们原来的方案，可能需要每次都修改pb文件，再编译服务再上线</p>
<p>旧的方式：<br>1、修改proto文件。<br>2、protoc 产出 *.pb.go文件，<br>3、编译服务。</p>
<p>但是实际上我们可以在golang 代码里面自动解析proto文件，整个流程在服务内部自动完成。</p>
<p>新的方式：<br>1、启动服务（从配置服务器加载 proto文件）<br>2、通过proto文件产生的一个 FileDescriptor ，进而根据对象名称找到 MessageDescriptor<br>3、直接用MessageDescriptor </p>
<p>可以看到新的方式 ,本质就是需要实现动态pb解析和协议转换的工作。</p>
<p>下面我们看示例代码<br>保存如下pb定义为test.proto</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto2&quot;;</span><br><span class="line">package test;</span><br><span class="line">message AddFriendReq &#123;</span><br><span class="line">	repeated string phone = 1;</span><br><span class="line">	optional string keyword =2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>示例代码<br>代码本身是依赖了一个三方包：github.com/jhump/protoreflect</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line">	testpb <span class="string">&quot;github.com/lilien1010/my_gotest/proto&quot;</span> <span class="comment">//这个包是从上面的pb文件生产的，用来做序列化测试</span></span><br><span class="line">	<span class="string">&quot;github.com/golang/protobuf/proto&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jhump/protoreflect/desc/protoparse&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jhump/protoreflect/desc/protoprint&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/jhump/protoreflect/dynamic&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	Filename := <span class="string">&quot;./proto/test.proto&quot;</span></span><br><span class="line"></span><br><span class="line">	Parser := protoparse.Parser&#123;&#125;</span><br><span class="line">        <span class="comment">//加载并解析 proto文件,得到一组 FileDescriptor</span></span><br><span class="line">	descs, err := Parser.ParseFiles(Filename)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;ParseFiles err=%v&quot;</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">       <span class="comment">//这里的代码是为了测试打印</span></span><br><span class="line">	Printer := &amp;protoprint.Printer&#123;&#125;</span><br><span class="line">	<span class="keyword">var</span> buf bytes.Buffer</span><br><span class="line">	Printer.PrintProtoFile(descs[<span class="number">0</span>], &amp;buf)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;descsStr=%s\n&quot;</span>, buf.String())</span><br><span class="line">      </span><br><span class="line">        <span class="comment">//descs 是一个数组，这里因为只有一个文件，就取了第一个元素.</span></span><br><span class="line">        <span class="comment">//通过proto的message名称得到MessageDescriptor 结构体定义描述符</span></span><br><span class="line">	msg := descs[<span class="number">0</span>].FindMessage(<span class="string">&quot;test.AddFriendReq&quot;</span>)</span><br><span class="line">        <span class="comment">//再用消息描述符，动态的构造一个pb消息体</span></span><br><span class="line">	dmsg := dynamic.NewMessage(msg)</span><br><span class="line">        </span><br><span class="line">       <span class="comment">//pb二进制消息 做反序列化 到 test.AddFriendReq 这个消息体</span></span><br><span class="line">	err = dmsg.Unmarshal(GetMessageBin())</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//把test.AddFriendReq 消息体序列化成 JSON 数据</span></span><br><span class="line">	jsStr, _ := dmsg.MarshalJSON()</span><br><span class="line">	fmt.Printf(<span class="string">&quot;jsStr=%s\n&quot;</span>, jsStr) </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//可能从远程服务得到一些二进制数据，这里为了方便测试，用本地序列化的pb</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetMessageBin</span><span class="params">()</span></span> []<span class="type">byte</span> &#123;</span><br><span class="line">	req := &amp;testpb.AddFriendReq&#123;</span><br><span class="line">		Phone:   []<span class="type">string</span>&#123;<span class="string">&quot;13145990022&quot;</span>, <span class="string">&quot;131313233&quot;</span>&#125;,</span><br><span class="line">		Keyword: proto.String(<span class="string">&quot;I am good&quot;</span>),</span><br><span class="line">	&#125; </span><br><span class="line">	bin, err := proto.Marshal(req) </span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;bin=%v,err=%v&quot;</span>, bin, err)</span><br><span class="line">	&#125; </span><br><span class="line">	<span class="keyword">return</span> bin</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/04/06/About-Me/">About Me</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-04-06T09:14:15.000Z" itemprop="datePublished">2021-04-06</time>
</a>

            

        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <ul>
<li>Shopify Engineer</li>
<li>Apahce APISIX PMC</li>
<li>KubeSphere Member</li>
<li>Openresty Contributor</li>
<li>Anyway, can be a OpenSource Contributor</li>
<li>Used to work with Lua, Golang, Openresty, K8S, React.</li>
<li>Tiny Individual Entrepreneur</li>
</ul>
<p>Previously served at <a href="HelloTalk.com">HelloTalk</a> and <a href="tencent.com">Tencent</a></p>
<h3 id="Hi-Dude"><a href="#Hi-Dude" class="headerlink" title="Hi Dude"></a>Hi Dude</h3><ul>
<li>🐳 I’m currently learning\working on Golang\K8S\OpenResty\APISIX\Ruby. </li>
<li>🤔 I’m thinking changing the world more or less. </li>
<li>💬 Welcomed to ask me about <code>debug</code>. </li>
<li>📫 How to reach me: <a href="liling@apache.org">email:liling@apache.org</a></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/lilien1010"><img src="https://github-readme-stats.vercel.app/api?username=lilien1010" alt="Liling&#39;s github stats"></a><br>[<img src="https://raw.githubusercontent.com/lilien1010/lilien1010/master/wechat.jpg" alt="Wechat">]</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2021/03/13/%E4%BD%BF%E7%94%A8-Github-Action-%E8%87%AA%E5%8A%A8%E5%8F%91%E5%B8%83%E9%95%9C%E5%83%8F%E5%88%B0Dockerhub/">使用 Github Action 自动发布Docker镜像到 Dockerhub</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2021-03-13T03:24:46.000Z" itemprop="datePublished">2021-03-13</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/Docker/" rel="tag">Docker</a>, <a class="article-tag-link" href="/tags/Github/" rel="tag">Github</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>因为工作需要 用到自定义的 PHP+Openresty 镜像, 所以自建构建了一个镜像存放在dockerhub。</p>
<p><a target="_blank" rel="noopener" href="https://hub.docker.com/repository/docker/lilien1010/php_openresty">Dockerhub:lilien1010/php_openresty</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/lilien1010/php_openresty">Dockfile:php_openresty</a></p>
<p>但是每次在 dockfile 里面添加修改一点东西 都要手动 发布image 到 dockerhub 很费时费力。</p>
<p>所以可以用 github action 来完成自动化的工作。</p>
<h3 id="开通-Dockerhub-token"><a href="#开通-Dockerhub-token" class="headerlink" title="开通 Dockerhub token"></a>开通 Dockerhub token</h3><ul>
<li>open (<a target="_blank" rel="noopener" href="https://hub.docker.com/settings/security)[https://hub.docker.com/settings/security]">https://hub.docker.com/settings/security)[https://hub.docker.com/settings/security]</a></li>
<li>click New Access Token</li>
</ul>
<p>  <img src="/images/2021-04-13-11-30-10.png"></p>
<h3 id="配置-Github-秘钥"><a href="#配置-Github-秘钥" class="headerlink" title="配置 Github  秘钥"></a>配置 Github  秘钥</h3><p>  把 dockhub 的用户名和 token 填写到 secrets 环境。</p>
<p><img src="/images/2021-04-13-11-32-46.png"></p>
<h3 id="配置-Github-Action"><a href="#配置-Github-Action" class="headerlink" title="配置 Github Action"></a>配置 Github Action</h3><p>  参考：<a target="_blank" rel="noopener" href="https://github.com/lilien1010/php_openresty/blob/master/.github/workflows/push_dockerhub.yml">workflows/push_dockerhub.yml</a></p>
<p>  注意：下面的 DOCKERHUB_USERNAME 和 DOCKERHUB_TOKEN 这两个名字要和在 github repo setting 里面配置的 secrets 要一致。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">name: ci</span><br><span class="line"></span><br><span class="line">on:</span><br><span class="line">  push:</span><br><span class="line">    branches:</span><br><span class="line">      - &#x27;master&#x27;</span><br><span class="line"></span><br><span class="line">jobs:</span><br><span class="line">  docker:</span><br><span class="line">    runs-on: ubuntu-latest</span><br><span class="line">    steps:</span><br><span class="line">      -</span><br><span class="line">        name: Checkout</span><br><span class="line">        uses: actions/checkout@v2</span><br><span class="line">      -</span><br><span class="line">        name: Set up QEMU</span><br><span class="line">        uses: docker/setup-qemu-action@v1</span><br><span class="line">      -</span><br><span class="line">        name: Set up Docker Buildx</span><br><span class="line">        uses: docker/setup-buildx-action@v1</span><br><span class="line">      -</span><br><span class="line">        name: Login to DockerHub</span><br><span class="line">        uses: docker/login-action@v1</span><br><span class="line">        with:</span><br><span class="line">          username: $&#123;&#123; secrets.DOCKERHUB_USERNAME &#125;&#125;</span><br><span class="line">          password: $&#123;&#123; secrets.DOCKERHUB_TOKEN &#125;&#125;</span><br><span class="line">      -</span><br><span class="line">        name: Build and push</span><br><span class="line">        uses: docker/build-push-action@v2</span><br><span class="line">        with:</span><br><span class="line">          context: .</span><br><span class="line">          push: true</span><br><span class="line">          tags: lilien1010/php_openresty:latest</span><br></pre></td></tr></table></figure>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2017/03/17/MySql%E7%9A%84MHA%E9%AB%98%E5%8F%AF%E7%94%A8%E9%83%A8%E7%BD%B2/">MySql的MHA高可用部署</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2017-03-17T14:04:50.000Z" itemprop="datePublished">2017-03-17</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/Mysql/" rel="tag">Mysql</a>, <a class="article-tag-link" href="/tags/backend/" rel="tag">backend</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><p>1：先来说一下为什么会出现这种方案，以及这个方案是怎么回事儿？</p>
<p>只要是个服务，就都有宕机的可能，Mysql也不例外，为了让各位运维、DBA、和全栈工程师晚上能睡个安稳觉，有更多的时间和女朋友么么哒，我们希望数据库服务器在宕机的时候能自动恢复过来，最少的影响用户的体验，留下更多的奖金买001。</p>
<p>这个时候我们的MHA（Mysql Highe Available）大显身手了，他的原理就一句话：在Mysql的主从架构下，当主库挂掉的时候，自动将备库升级为主库，同时为其他备库重新设置新的主库。</p>
<p>假设我们有服务器<br>A：192.168.1.60  (主库)<br>B：192.168.1.70（备库，备主[主库宕机的情况,提升B为主库]）<br>C：192.168.1.80（备库2）<br>D：192.168.1.88 （manager，MHA管理中心，安装MHA manager，在主库和备库上面都需要安装MHA node，manager管理node）</p>
<p>让B C 成为A的 slave 机 就不在这里介绍了，很简单的配置.</p>
<p>2：具体原理如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">（1）从宕机崩溃的master保存二进制日志事件（binlog events）;</span><br><span class="line"></span><br><span class="line">（2）识别含有最新更新的slave；</span><br><span class="line"></span><br><span class="line">（3）应用差异的中继日志（relay log）到其他的slave；</span><br><span class="line"></span><br><span class="line">（4）应用从master保存的二进制日志事件（binlog events）；</span><br><span class="line"></span><br><span class="line">（5）提升一个slave为新的master；</span><br><span class="line"></span><br><span class="line">（6）使其他的slave连接新的master进行复制；</span><br></pre></td></tr></table></figure>


<p>3：MHA的安装，因为MHA的功能是通过perl脚本来实现的，所以我们要安装perl环境</p>
<p>A: 让A B C D四台机子互相无密码登陆</p>
<p>查看A B C D 主机 /root/.ssh/ 下面有没有 id_rsa.pub 文件</p>
<p>如果没有从新生成 ssh-keygen -t rsa -b 2048 </p>
<p>然后通过scp命令拷贝到其他三台机子，如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.1.88 ~]# scp id_rsa.pub root@192.168.1.60:/root/.ssh/ //复制到主机60</span><br><span class="line"></span><br><span class="line">[root@192.168.1.60 ~]# cat id_rsa.pub &gt;&gt; authorized_keys</span><br></pre></td></tr></table></figure>
<p>安装必要的perl库，</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.1.88 ~]# yum install cpan perl</span><br><span class="line">[root@192.168.1.88 ~]# yum -y install perl-MIME-Lite perl-Params-Validate perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Time-HiRes</span><br><span class="line">[root@192.168.1.88 ~]# wget ftp://ftp.muug.mb.ca/mirror/centos/6.5/os/x86_64/Packages/compat-db43-4.3.29-15.el6.x86_64.rpm</span><br><span class="line">[root@192.168.1.88 ~]# wget http://downloads.naulinux.ru/pub/NauLinux/6x/i386/sites/School/RPMS/perl-Log-Dispatch-2.27-1.el6.noarch.rpm</span><br><span class="line">[root@192.168.1.88 ~]# wget http://dl.fedoraproject.org/pub/epel/6/i386/perl-Parallel-ForkManager-0.7.9-1.el6.noarch.rpm</span><br><span class="line">[root@192.168.1.88 ~]# wget http://dl.fedoraproject.org/pub/epel/6/i386/perl-Mail-Sender-0.8.16-3.el6.noarch.rpm</span><br><span class="line">[root@192.168.1.88 ~]# wget http://dl.fedoraproject.org/pub/epel/6/i386/perl-Mail-Sendmail-0.79-12.el6.noarch.rpm</span><br><span class="line">[root@192.168.1.88 ~]# wget http://mirror.centos.org/centos/6/os/x86_64/Packages/perl-Time-HiRes-1.9721-136.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">[root@192.168.1.88 ~]# rpm -ivh perl-Parallel-ForkManager-0.7.9-1.el6.noarch.rpm perl-Log-Dispatch-2.27-1.el6.noarch.rpm perl-Mail-Sender-0.8.16-3.el6.noarch.rpm perl-Mail-Sendmail-0.79-12.el6.noarch.rpm perl-Time-HiRes-1.9721-136.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">再安装MHA manager（在192.168.1.88上）</span><br><span class="line"></span><br><span class="line">[root@192.168.1.88 ~]# wget https://downloads.mariadb.com/files/MHA/mha4mysql-manager-0.55-0.el6.noarch.rpm </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@192.168.1.88 ~]# rpm -ivh mha4mysql-manager-0.55-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">安装过程中会出现一些缺失的库，自己再去找对应的库就好了；</span><br><span class="line"></span><br><span class="line">再在从库安装MHA node（在192.168.1.50、192.168.1.60、192.168.1.70，A、B、C上）</span><br><span class="line"></span><br><span class="line">[root@A-B-C ~]#wget https://downloads.mariadb.com/files/MHA/mha4mysql-node-0.54-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@A-B-C~]#rpm -ivh mha4mysql-node-0.54-0.el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">（缺失perl库的话，按第一步来装好）</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>配置Manager</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">shell&gt; mkdir -p /masterha/app1    //创建app目录，用来存放临时数据文件，</span><br><span class="line">shell&gt; mkdir /etc/masterha        //创建目录，配置文件目录</span><br><span class="line">shell&gt; vi /etc/masterha/app1.cnf  //创建配置文件</span><br><span class="line">[server default]</span><br><span class="line">user=root                //linux用于管理mysql用戶名</span><br><span class="line">password=123456          //linux用于管理mysql密码</span><br><span class="line">manager_workdir=/masterha/app1</span><br><span class="line">manager_log=/masterha/app1/manager.log</span><br><span class="line">remote_workdir=/masterha/app1</span><br><span class="line">ssh_user=root            //ssh免密钥登录的帐号名</span><br><span class="line">repl_user=slaver         //mysql复制帐号，用来在主从机之间同步二进制日志等</span><br><span class="line">repl_password=slaver     //mysql密码</span><br><span class="line">ping_interval=1          //ping间隔，用来检测master是否正常</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=192.168.1.70 </span><br><span class="line">port=3306 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">hostname=192.168.1.80</span><br><span class="line">port=3306 </span><br></pre></td></tr></table></figure>

<p>设置relay log的清除方式（在每个slave节点上）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.80 ~]# mysql -e &#x27;set global relay_log_purge=0&#x27;</span><br><span class="line">[root@192.168.0.70 ~]# mysql -e &#x27;set global relay_log_purge=0’</span><br></pre></td></tr></table></figure>




<p>2、masterha_check_ssh工具验证ssh信任登录是否成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.88 ~]# masterha_check_ssh --conf=/etc/masterha/app1.cnf</span><br></pre></td></tr></table></figure>


<p>注意：用ssh-keygen实现4台主机之间相互免密钥登录决定这一步是否成功。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Wed Apr  23 22:10:01 2014 - [debug]   ok.</span><br><span class="line">Wed Apr  23 22:10:01 2014 - [info] All SSH connection tests passed successfully.</span><br></pre></td></tr></table></figure>



<p>3、masterha_check_repl工具验证mysql复制是否成功</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@192.168.0.88 ~]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br></pre></td></tr></table></figure>

<p>注意：上一篇文章中的master–slaver是否成功决定这一步是否成功。或是MHA文件配置的用户账号有关。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">port=3306 </span><br><span class="line">candidate_master=1</span><br><span class="line">master_binlog_dir=/data/mysql</span><br><span class="line">[server1]</span><br><span class="line">hostname=192.168.1.60</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Wed Apr 23 22:10:56 2014 - [info] Checking replication health on 192.168.1.232..</span><br><span class="line">Wed Apr 23 22:10:56 2014 - [info]  ok.</span><br><span class="line">Wed Apr 23 22:10:56 2014 - [warning] master_ip_failover_script is not defined.</span><br><span class="line">Wed Apr 23 22:10:56 2014 - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Apr 23 22:10:56 2014 - [info] Got exit code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK</span><br></pre></td></tr></table></figure>



<p>在出库上面停止mysql，模拟宕机的情况 </p>
<p>[<a href="mailto:&#114;&#111;&#111;&#116;&#x40;&#x31;&#x39;&#x32;&#46;&#x31;&#54;&#x38;&#x2e;&#48;&#46;&#x36;&#48;">&#114;&#111;&#111;&#116;&#x40;&#x31;&#x39;&#x32;&#46;&#x31;&#54;&#x38;&#x2e;&#48;&#46;&#x36;&#48;</a> ~]#service mysql stop</p>
<p>我们可以在 manager 机器上面看到输出的日志</p>
<p>[<a href="mailto:&#x72;&#111;&#x6f;&#x74;&#x40;&#x31;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#46;&#48;&#x2e;&#x38;&#x38;">&#x72;&#111;&#x6f;&#x74;&#x40;&#x31;&#57;&#50;&#x2e;&#x31;&#x36;&#x38;&#46;&#48;&#x2e;&#x38;&#x38;</a> ~]tail -f /masterha/app1/manager.log</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2017/03/11/OpenResty-%E9%87%8C%E9%9D%A2%E7%9A%84-AES-%E5%8A%A0%E5%AF%86%E4%B9%8BECB%E6%A8%A1%E5%BC%8F/">OpenResty 里面的 AES 加密之ECB模式</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2017-03-11T14:11:50.000Z" itemprop="datePublished">2017-03-11</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/Openresty/" rel="tag">Openresty</a>, <a class="article-tag-link" href="/tags/backend/" rel="tag">backend</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>###先上地址（代码将就着用吧O(∩_∩)O哈哈~）<br>###<a target="_blank" rel="noopener" href="https://github.com/lilien1010/lua-aes">https://github.com/lilien1010/lua-aes</a></p>
<p>因为再nginx+lua，openresty项目要用到 AES的的ecb模式加解密，<br>但是春哥用openssl实现的string库 我个人觉得不是很好理解。<br>作为一个PHPer，于是参照php的 mcrypt库，利用luajit的ffi实现了一个aes加解密的库。</p>
<p>aes encrypt with PHP:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">mcrypt_encrypt</span>(MCRYPT_RIJNDAEL_128, <span class="variable">$key</span>,<span class="variable">$text</span>, MCRYPT_MODE_ECB );</span><br></pre></td></tr></table></figure>

<p>aes encrypt with lua:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> data      =   <span class="string">&#x27;wait to be encrypted&#x27;</span></span><br><span class="line"><span class="keyword">local</span> key       =   <span class="string">&#x27;01234567890123456&#x27;</span> <span class="comment">--length is 16</span></span><br><span class="line"><span class="keyword">local</span> mc_ecb    =   <span class="built_in">require</span>(<span class="string">&quot;resty.ecb_mcrypt&quot;</span>)</span><br><span class="line"><span class="keyword">local</span> ecb       =   mc_ecb:new();</span><br><span class="line"><span class="keyword">local</span> enc_data  =   ecb:encrypt(key,data );</span><br><span class="line">ngx.<span class="built_in">print</span>(enc_data)</span><br><span class="line"><span class="comment">--  you must use &#x27;ngx.print&#x27; rather then &#x27;ngx.say&#x27;</span></span><br><span class="line"><span class="comment">--  while &#x27;ngx.say&#x27; append a &#x27;\n&#x27;  at the end of string</span></span><br></pre></td></tr></table></figure>
<p>######需要注意输出的数据在客户端要主要数据尾巴后面的<code>\0</code>,因为默认是有padding模式的。而且输出加密后的二进制数据，一定要用ngx.print,因为ngx.say会在数据的最后输出换行符（已经坑了部分人了）</p>
<p>同时你需要在操作系统里面安装 libmcrypt的库 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install libmcrypt libmcrypt-devel</span><br></pre></td></tr></table></figure>

<p>如果解析不出来 可能是因为 默认的padding模式，需要删除尾巴后面的空格，解析的时候要去掉 padding</p>
<p>其实利用类似的想法，基本上 OpenResty 里面缺少的库，利用 luajit 的 ffi 从 php 扩展里面参照代码，实现一份，还是挺简单的。</p>

        
    </section>
</article>


    <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            <a href="/2016/01/06/lua-charCodeAt/">lua-charCodeAt</a>
        </h1>
        
        <div class="article-meta clearfix">
            <a class="article-date" href="http://blog.hellotalk.org/index.html">
    
    <i class="icon-calendar vm"></i>
    
    <time class="vm" datetime="2016-01-06T14:02:42.000Z" itemprop="datePublished">2016-01-06</time>
</a>

            
<div class="article-tag-list">
    <i class="icon-tag vm"></i>
    <a class="article-tag-link" href="/tags/Openresty/" rel="tag">Openresty</a>, <a class="article-tag-link" href="/tags/backend/" rel="tag">backend</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
        <p>JS函数charCodeAt的Lua实现</p>
<h1 id="charCodeAt-by-Lua"><a href="#charCodeAt-by-Lua" class="headerlink" title="charCodeAt  by Lua"></a>charCodeAt  by Lua</h1><p>@(Lua JavaScript charCodeAt)</p>
<blockquote>
<p>I wanted to have a function <code>charCodeAt</code>  in  <strong>Lua</strong> ,and it should works exactly like <code>javascript</code><br>but with Lua5.1 ,UTF8 and Unicode are not supported,</p>
</blockquote>
<h3 id="1-how-charCodeAt-works-in-javascript"><a href="#1-how-charCodeAt-works-in-javascript" class="headerlink" title="1: how charCodeAt works  in javascript"></a>1: how charCodeAt works  in javascript</h3><p><code>to show Console  press F12 in Chrome( MAC:CMD+alt+J) </code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line"><span class="string">&#x27;你&#x27;</span>.<span class="title function_">charCodeAt</span>(<span class="number">0</span>),</span><br><span class="line"><span class="string">&#x27;ñ&#x27;</span>.<span class="title function_">charCodeAt</span>(<span class="number">0</span>),</span><br><span class="line"><span class="string">&#x27;n&#x27;</span>.<span class="title function_">charCodeAt</span>(<span class="number">0</span>)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p> it will output [20320, 241, 110]  ，it means the numeric value of Unicode ,  ‘你’=20320 , ‘ñ’=241, ‘n’=110. </p>
<blockquote>
<p>The charCodeAt() method returns the numeric Unicode value of the character at the given index (except for unicode codepoints &gt; 0x10000).</p>
</blockquote>
<p>according to  alexander-yakushev  we can know how many bytes one UTF8 word takes using function <code>utf8.charbytes</code><br> [<a target="_blank" rel="noopener" href="https://github.com/alexander-yakushev/awesompd/blob/master/utf8.lua]">https://github.com/alexander-yakushev/awesompd/blob/master/utf8.lua]</a> </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">utf8.charbytes</span> <span class="params">(s, i)</span></span></span><br><span class="line">   <span class="comment">-- argument defaults</span></span><br><span class="line">   i = i <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">   <span class="keyword">local</span> c = <span class="built_in">string</span>.<span class="built_in">byte</span>(s, i) </span><br><span class="line">   <span class="comment">-- determine bytes needed for character, based on RFC 3629</span></span><br><span class="line">   <span class="keyword">if</span> c &gt; <span class="number">0</span> <span class="keyword">and</span> c &lt;= <span class="number">127</span> <span class="keyword">then</span></span><br><span class="line">      <span class="comment">-- UTF8-1 byte</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">   <span class="keyword">elseif</span> c &gt;= <span class="number">194</span> <span class="keyword">and</span> c &lt;= <span class="number">223</span> <span class="keyword">then</span></span><br><span class="line">      <span class="comment">-- UTF8-2 byte</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">   <span class="keyword">elseif</span> c &gt;= <span class="number">224</span> <span class="keyword">and</span> c &lt;= <span class="number">239</span> <span class="keyword">then</span></span><br><span class="line">      <span class="comment">-- UTF8-3 byte</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">   <span class="keyword">elseif</span> c &gt;= <span class="number">240</span> <span class="keyword">and</span> c &lt;= <span class="number">244</span> <span class="keyword">then</span></span><br><span class="line">      <span class="comment">-- UTF8-4 byte</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">4</span></span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="Unicode-amp-UTF8-convert-method"><a href="#Unicode-amp-UTF8-convert-method" class="headerlink" title="Unicode &amp; UTF8 convert  method"></a>Unicode &amp; UTF8 convert  method</h4><table>
<thead>
<tr>
<th align="left">Unicode code range</th>
<th align="left">UTF-8 code</th>
<th align="left">example</th>
</tr>
</thead>
<tbody><tr>
<td align="left">hex code</td>
<td align="left">binary code</td>
<td align="left">char</td>
</tr>
<tr>
<td align="left">0000 0000-0000 007F</td>
<td align="left">0xxxxxxx</td>
<td align="left"><code>n</code>(alphabet)</td>
</tr>
<tr>
<td align="left">0000 0000-0000 007F</td>
<td align="left">110xxxxx 10xxxxxx</td>
<td align="left"><code>ñ</code></td>
</tr>
<tr>
<td align="left">0000 0080-0000 07FF</td>
<td align="left">1110xxxx 10xxxxxx 10xxxxxx</td>
<td align="left"><code>你</code>(most CJK)</td>
</tr>
<tr>
<td align="left">0001 0000-0010 FFFF</td>
<td align="left">11110xxx 10xxxxxx 10xxxxxx 10xxxxxx</td>
<td align="left"><code>other chars</code></td>
</tr>
</tbody></table>
<p>but we should pay attention to  4 bytes UTF8[<code>emoji</code>], it works not that simple</p>
<h3 id="special-Method"><a href="#special-Method" class="headerlink" title="special Method"></a>special Method</h3><p>javascript  engine using UTF16，characters in <code>Basic Multilingual Plane</code> were the same with unicode, but if the characters  were in   <code>Supplementary Plane</code>  it should use the formula below，usually we encounter <code>Supplementary Plane</code> emoji like😝 (4  byte UTF8 character)</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- formula 1</span></span><br><span class="line">H = Math.<span class="built_in">floor</span>((c<span class="number">-0x10000</span>) / <span class="number">0x400</span>)+<span class="number">0xD800</span> </span><br><span class="line">L = (c - <span class="number">0x10000</span>) % <span class="number">0x400</span> + <span class="number">0xDC00</span></span><br></pre></td></tr></table></figure>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><p>###code is here<br>###<a target="_blank" rel="noopener" href="https://github.com/lilien1010/lua-bit">https://github.com/lilien1010/lua-bit</a></p>
<h2 id="Feedback-amp-Bug-Report"><a href="#Feedback-amp-Bug-Report" class="headerlink" title="Feedback &amp; Bug Report"></a>Feedback &amp; Bug Report</h2><ul>
<li>Twitter: <a target="_blank" rel="noopener" href="https://twitter.com/LeenuxLee">@LeenuxLee</a></li>
<li>Email: <a href="mailto:&#108;&#x69;&#108;&#x69;&#x6e;&#x67;&#x40;&#x61;&#112;&#x61;&#x63;&#104;&#x65;&#46;&#x6f;&#114;&#103;">&#108;&#x69;&#108;&#x69;&#x6e;&#x67;&#x40;&#x61;&#112;&#x61;&#x63;&#104;&#x65;&#46;&#x6f;&#114;&#103;</a></li>
</ul>
<hr>
<p>Thank you for reading this  , if you got any better idea, share it.</p>

        
    </section>
</article>






            </div>
        </div>
        <footer class="footer">
    Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, Theme by <a href="https://github.com/sanonz/hexo-theme-concise" target="_blank">Concise</a>

    
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?54b70fad0249c2f4ed1e062b7961facb";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
    
</footer>

    </main>

    <script type="text/javascript" src="https://unpkg.com/jquery@1.9.1/jquery.min.js"></script>
    <script type="text/javascript">
    $(function() {
        var nodes = {
            nav: $('#nav'),
            aside: $('#aside'),
            asideInner: $('#aside-inner'),
            navInner: $('#nav-inner')
        };

        var doing = false;
        nodes.asideInner.on('webkitAnimationEnd mozAnimationEnd oAnimationEnd oanimationend animationend', function() {
            if (nodes.aside.hasClass('mobile-open')) {
                nodes.aside.removeClass('mobile-open');
            } else {
                nodes.aside.removeClass('mobile-close panel-show');
            }
            doing = false;
        });
        $('#open-panel, #aside-mask').on('click', function() {
            if (doing) {
                return;
            }

            if (nodes.aside.hasClass('panel-show')) {
                nodes.aside.addClass('mobile-close');
            } else {
                nodes.aside.addClass('mobile-open panel-show');
            }
        });
        $('#open-menus').on('click', function() {
            nodes.navInner.slideToggle('normal', slideDone);
        });

        if (window.innerWidth <= 960) {
            setTimeout(function() {
                nodes.navInner.slideUp('normal', slideDone);
            }, 3000);
        }

        function slideDone() {
            if (nodes.navInner.css('display') !== 'none') {
                nodes.navInner.css('display', '');
            }
        }

        $(window).on('resize', function() {
            if ($(this).width() > 960) {
                nodes.navInner.css('display', '');
            }
        });
    });
    </script>
    

</body>
</html>
